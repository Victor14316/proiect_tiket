<head>
    <meta charset="UTF-8">
    <title>Administrare Sală Spectacole</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Pagina Administrativă</h1>
    <p>Aici personalul poate vedea și edita toate rezervările sau poate adăuga una nouă.</p>
    <form id="adminReservationForm" style="margin-bottom:20px;">
        <input type="text" id="adminName" placeholder="Nume" required>
        <input type="date" id="adminDate" required>
        <select id="adminHour" required>
            <option value="">Alege ora</option>
            <option>12:00</option>
            <option>16:00</option>
            <option>20:00</option>
        </select>
        <input type="number" id="adminSeat" placeholder="selectează loc" readonly required style="width:120px;">
        <button type="submit">Adaugă rezervare</button>
    </form>
    <div id="admin-cinema" class="cinema"></div>
    <div id="admin-reservations"></div>
    <button id="saveBtn">Salvează modificările</button>
    <script>
    const TOTAL_SEATS = 30;
    let reservations = [];
    function renderCinema() {
        const container = document.getElementById('admin-cinema');
        container.innerHTML = '';
        let table = document.createElement('table');
        let seatNumber = 1;
        const date = document.getElementById('adminDate').value;
        const hour = document.getElementById('adminHour').value;
        for (let row = 0; row < 6; row++) {
            if (seatNumber > TOTAL_SEATS) break;
            let tr = document.createElement('tr');
            for (let col = 0; col < 5; col++) {
                if (seatNumber > TOTAL_SEATS) break;
                let td = document.createElement('td');
                // Filtrare rezervări pentru data și oră selectate
                const reserved = reservations.some(r => Number(r.seat) === seatNumber && r.date === date && r.hour === hour);
                let btn = document.createElement('button');
                btn.textContent = seatNumber;
                btn.style.width = '40px';
                btn.style.height = '40px';
                btn.style.margin = '4px';
                btn.style.fontWeight = 'bold';
                btn.style.background = reserved ? '#f44336' : '#4caf50';
                btn.style.color = '#fff';
                btn.disabled = reserved || !date || !hour;
                if (!reserved && date && hour) {
                    btn.onclick = () => {
                        document.getElementById('adminSeat').value = seatNumber;
                    };
                }
                td.appendChild(btn);
                tr.appendChild(td);
                seatNumber++;
            }
            table.appendChild(tr);
        }
        container.appendChild(table);
    }
    function renderTable() {
        const container = document.getElementById('admin-reservations');
        container.innerHTML = '';
        const table = document.createElement('table');
        table.style.borderCollapse = 'collapse';
        table.innerHTML = `<tr><th>Nume</th><th>Loc</th><th>Dată</th><th>Oră</th><th>Șterge</th></tr>`;
        reservations.forEach((r, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input value="${r.name}" data-idx="${idx}" data-field="name"></td>
                <td><input type="number" min="1" max="30" value="${r.seat}" data-idx="${idx}" data-field="seat"></td>
                <td><input type="date" value="${r.date || ''}" data-idx="${idx}" data-field="date"></td>
                <td><input value="${r.hour}" data-idx="${idx}" data-field="hour"></td>
                <td><button data-idx="${idx}" class="deleteBtn">Șterge</button></td>
            `;
            table.appendChild(tr);
        });
        container.appendChild(table);
        // Evenimente pentru editare
        container.querySelectorAll('input').forEach(input => {
            input.onchange = (e) => {
                const idx = e.target.getAttribute('data-idx');
                const field = e.target.getAttribute('data-field');
                reservations[idx][field] = e.target.value;
            };
        });
        // Evenimente pentru ștergere
        container.querySelectorAll('.deleteBtn').forEach(btn => {
            btn.onclick = (e) => {
                const idx = e.target.getAttribute('data-idx');
                reservations.splice(idx, 1);
                renderTable();
            };
        });
    }
    function loadReservations() {
        fetch('/api/reservations')
            .then(res => res.json())
            .then(data => {
                reservations = data;
                renderCinema();
                renderTable();
            });
    }
    document.getElementById('saveBtn').onclick = () => {
        fetch('/api/save-reservations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(reservations)
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) alert('Rezervările au fost salvate!');
            else alert('Eroare la salvare!');
            loadReservations();
        });
    };
    document.getElementById('adminReservationForm').onsubmit = (e) => {
        e.preventDefault();
        const name = document.getElementById('adminName').value;
        const date = document.getElementById('adminDate').value;
        const hour = document.getElementById('adminHour').value;
        const seat = document.getElementById('adminSeat').value;
        if (!name || !date || !hour || !seat) return alert('Completează toate câmpurile!');
        // Verifică dacă locul e deja rezervat pentru data și ora selectată
        if (reservations.some(r => r.seat == seat && r.date === date && r.hour === hour)) {
            alert('Locul este deja rezervat pentru această dată și oră!');
            return;
        }
        reservations.push({ name, seat, date, hour });
        document.getElementById('adminReservationForm').reset();
        document.getElementById('adminSeat').placeholder = 'selectează loc';
        renderCinema();
        renderTable();
    };
    document.getElementById('adminDate').onchange = () => {
        document.getElementById('adminSeat').value = '';
        renderCinema();
    };
    document.getElementById('adminHour').onchange = () => {
        document.getElementById('adminSeat').value = '';
        renderCinema();
    };
    document.addEventListener('DOMContentLoaded', loadReservations);
    </script>
</body>
</html>
