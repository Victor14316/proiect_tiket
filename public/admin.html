<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Administrare SalÄƒ Spectacole</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Stiluri pentru Dashboard (Cardurile de sus) */
        .dashboard {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            text-align: center;
        }
        .card h3 { margin: 0 0 10px 0; font-size: 16px; color: #555; }
        .card p { margin: 0; font-size: 24px; font-weight: bold; color: #333; }
        
        /* Stil pentru Search */
        #searchInput {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box; /* SÄƒ nu iasÄƒ din paginÄƒ */
        }
    </style>
</head>
<body>
    <h1>Pagina AdministrativÄƒ</h1>
    <p>Aici personalul poate vedea statistici, edita rezervÄƒrile sau adÄƒuga una nouÄƒ.</p>

    <div class="dashboard">
        <div class="card">
            <h3>ÃŽncasÄƒri Totale (Estimat)</h3>
            <p id="total-revenue">0 RON</p>
        </div>
        <div class="card">
            <h3>Bilete VÃ¢ndute</h3>
            <p id="total-tickets">0</p>
        </div>
        <div class="card">
            <h3>Grad Ocupare (Zilnic)</h3>
            <p id="occupancy-rate">0%</p>
        </div>
    </div>

    <form id="adminReservationForm" style="margin-bottom:20px; background:#f9f9f9; padding:15px; border-radius:8px;">
        <h3>AdaugÄƒ Rezervare ManualÄƒ</h3>
        <input type="text" id="adminName" placeholder="Nume Client" required>
        <input type="date" id="adminDate" required>
        <select id="adminHour" required>
            <option value="">Alege ora</option>
            <option>12:00</option>
            <option>16:00</option>
            <option>20:00</option>
        </select>
        <input type="number" id="adminSeat" placeholder="Loc (selecteazÄƒ jos)" readonly required style="width:120px; background:#eee;">
        <button type="submit" style="background-color: #4caf50; color: white; border: none; padding: 10px; cursor: pointer;">AdaugÄƒ rezervare</button>
    </form>

    <div id="admin-cinema" class="cinema" style="margin-bottom: 30px;"></div>

    <h3>Lista RezervÄƒri</h3>
    <input type="text" id="searchInput" placeholder="ðŸ” CautÄƒ rezervare dupÄƒ numele clientului..." onkeyup="filterTable()">

    <div id="admin-reservations"></div>
    
    <br>
    <button id="saveBtn" style="padding: 10px 20px; background-color: #008CBA; color: white; border: none; cursor: pointer; font-size: 16px;">ðŸ’¾ SalveazÄƒ modificÄƒrile Ã®n bazÄƒ</button>

    <script>
    const TOTAL_SEATS = 30;
    const TICKET_PRICE = 50; // PreÈ› per bilet pentru KPI
    let reservations = [];

    // --- FUNCÈšII NOI (KPI & Search) ---

    function updateStats() {
        // CalculÄƒm KPI-urile
        const totalBilete = reservations.length;
        const incasari = totalBilete * TICKET_PRICE;
        
        // Calcul ocupare: raportat la capacitatea totalÄƒ teoreticÄƒ (30 locuri * 3 intervale orare * numÄƒr de zile distincte Ã®n rezervÄƒri)
        // Pentru simplificare, calculÄƒm raportat doar la rezervÄƒrile existente vs capacitate fixÄƒ "per zi" de referinÈ›Äƒ (90 locuri total pe zi)
        // Sau pur si simplu procent din sala plina per eveniment. Aici facem o medie simpla.
        const capacitateZilnica = TOTAL_SEATS * 3; // 3 spectacole pe zi
        // Daca avem rezervÄƒri pe mai multe zile, logica e complexÄƒ, dar pentru demo facem simplu:
        // CÃ¢te bilete s-au dat / (Nr zile cu rezervÄƒri * CapacitateZilnicÄƒ)
        
        const uniqueDates = [...new Set(reservations.map(r => r.date))].length || 1;
        const gradOcupare = (totalBilete / (capacitateZilnica * uniqueDates)) * 100;

        // ActualizÄƒm UI-ul
        document.getElementById('total-revenue').innerText = `${incasari} RON`;
        document.getElementById('total-tickets').innerText = totalBilete;
        document.getElementById('occupancy-rate').innerText = `${gradOcupare.toFixed(1)}%`;
    }

    function filterTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toUpperCase();
        const table = document.querySelector('#admin-reservations table');
        const tr = table.getElementsByTagName('tr');

        for (let i = 1; i < tr.length; i++) {
            let td = tr[i].getElementsByTagName('td')[0]; // Coloana Nume
            if (td) {
                let inputVal = td.querySelector('input').value;
                if (inputVal.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }

    // --- FUNCÈšII EXISTENTE (Modificate uÈ™or) ---

    function renderCinema() {
        const container = document.getElementById('admin-cinema');
        container.innerHTML = '';
        let table = document.createElement('table');
        let seatNumber = 1;
        const date = document.getElementById('adminDate').value;
        const hour = document.getElementById('adminHour').value;

        for (let row = 0; row < 6; row++) {
            if (seatNumber > TOTAL_SEATS) break;
            let tr = document.createElement('tr');

            for (let col = 0; col < 5; col++) {
                if (seatNumber > TOTAL_SEATS) break;
                let td = document.createElement('td');

                // GÄƒsim rezervarea
                const foundRes = reservations.find(r => Number(r.seat) === seatNumber && r.date === date && r.hour === hour);
                const reserved = !!foundRes;

                let btn = document.createElement('button');
                btn.textContent = seatNumber;
                btn.style.width = '40px';
                btn.style.height = '40px';
                btn.style.margin = '4px';
                btn.style.fontWeight = 'bold';
                btn.style.borderRadius = '4px';
                btn.style.border = '1px solid #ccc';
                btn.style.cursor = reserved ? 'not-allowed' : 'pointer';
                
                // Culoare: RoÈ™u (Ocupat) / Verde (Liber)
                btn.style.background = reserved ? '#f44336' : '#4caf50'; 
                btn.style.color = '#fff';

                // 3. TOOLTIP (NOU): AratÄƒ cine a rezervat cÃ¢nd pui mouse-ul
                if (reserved) {
                    btn.title = `Rezervat de: ${foundRes.name}`; 
                } else {
                    btn.title = "Loc liber";
                }

                btn.disabled = reserved || !date || !hour;

                if (!reserved && date && hour) {
                    btn.onclick = () => {
                        document.getElementById('adminSeat').value = seatNumber; // Folosim valoarea corecta din closure
                        // Resetam stilul vizual temporar pentru selectie (opÈ›ional)
                        document.querySelectorAll('#admin-cinema button').forEach(b => b.style.border = '1px solid #ccc');
                        btn.style.border = '3px solid blue';
                    };
                    // Fix pentru closure (seatNumber trebuie capturat)
                    let currentSeat = seatNumber; 
                    btn.onclick = () => {
                         document.getElementById('adminSeat').value = currentSeat;
                    }
                }

                td.appendChild(btn);
                tr.appendChild(td);
                seatNumber++;
            }
            table.appendChild(tr);
        }
        container.appendChild(table);
    }

    function renderTable() {
        const container = document.getElementById('admin-reservations');
        container.innerHTML = '';
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.innerHTML = `
            <tr style="background:#f2f2f2; text-align:left;">
                <th style="padding:10px;">Nume</th>
                <th>Loc</th>
                <th>DatÄƒ</th>
                <th>OrÄƒ</th>
                <th>AcÈ›iuni</th>
            </tr>`;

        reservations.forEach((r, idx) => {
            const tr = document.createElement('tr');
            tr.style.borderBottom = '1px solid #ddd';
            tr.innerHTML = `
                <td style="padding:5px;"><input value="${r.name}" data-idx="${idx}" data-field="name" style="width:90%"></td>
                <td><input type="number" min="1" max="30" value="${r.seat}" data-idx="${idx}" data-field="seat" style="width:50px"></td>
                <td><input type="date" value="${r.date || ''}" data-idx="${idx}" data-field="date"></td>
                <td><input value="${r.hour}" data-idx="${idx}" data-field="hour" style="width:60px"></td>
                <td><button data-idx="${idx}" class="deleteBtn" style="background:#ff4444; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">È˜terge</button></td>
            `;
            table.appendChild(tr);
        });

        container.appendChild(table);

        // Evenimente Editare
        container.querySelectorAll('input').forEach(input => {
            input.onchange = (e) => {
                const idx = e.target.getAttribute('data-idx');
                const field = e.target.getAttribute('data-field');
                reservations[idx][field] = e.target.value;
                updateStats(); // Actualizam statistica daca se schimba ceva
            };
        });

        // Evenimente È˜tergere
        container.querySelectorAll('.deleteBtn').forEach(btn => {
            btn.onclick = (e) => {
                if(confirm('Sigur vrei sÄƒ È™tergi aceastÄƒ rezervare?')) {
                    const idx = e.target.getAttribute('data-idx');
                    reservations.splice(idx, 1);
                    renderTable();
                    renderCinema();
                    // updateStats() e chemat automat in renderTable mai jos
                }
            };
        });

        updateStats(); // CalculÄƒm statisticile de fiecare datÄƒ cÃ¢nd randÄƒm tabelul
    }

    function loadReservations() {
        fetch('/api/reservations')
            .then(res => res.json())
            .then(data => {
                reservations = data;
                renderCinema();
                renderTable();
            })
            .catch(err => console.error("Eroare la incarcare:", err));
    }

    document.getElementById('saveBtn').onclick = () => {
        fetch('/api/save-reservations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(reservations)
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) alert('âœ… ModificÄƒrile au fost salvate cu succes!');
            else alert('âŒ Eroare la salvare!');
            loadReservations();
        });
    };

    document.getElementById('adminReservationForm').onsubmit = (e) => {
        e.preventDefault();
        const name = document.getElementById('adminName').value;
        const date = document.getElementById('adminDate').value;
        const hour = document.getElementById('adminHour').value;
        const seat = document.getElementById('adminSeat').value;

        if (!name || !date || !hour || !seat) return alert('CompleteazÄƒ toate cÃ¢mpurile!');

        if (reservations.some(r => r.seat == seat && r.date === date && r.hour === hour)) {
            alert('Locul este deja rezervat pentru aceastÄƒ datÄƒ È™i orÄƒ!');
            return;
        }

        reservations.push({ name, seat, date, hour });
        document.getElementById('adminReservationForm').reset();
        document.getElementById('adminSeat').placeholder = 'Loc (selecteazÄƒ jos)';
        renderCinema();
        renderTable();
    };

    document.getElementById('adminDate').onchange = () => {
        document.getElementById('adminSeat').value = '';
        renderCinema();
    };

    document.getElementById('adminHour').onchange = () => {
        document.getElementById('adminSeat').value = '';
        renderCinema();
    };

    document.addEventListener('DOMContentLoaded', loadReservations);
    </script>
</body>
</html>